on:
  push:
    branches:
      - main
jobs:
  update-docker-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Check if Dockerfile.base changed
        id: dockerfile-check
        run: |
          # List files changed in this push
          changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          echo "Changed files in this push:"
          echo "$changed_files"

          # Count changes to Dockerfile.base
          changed_count=$(echo "$changed_files" | grep -c '^Dockerfile.base$' || true)
          echo "changed=$changed_count" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        if: steps.dockerfile-check.outputs.changed != '0'
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Update Base Docker Image
        if: steps.dockerfile-check.outputs.changed != '0'
        run: ./scripts/update_base_docker_image.sh
