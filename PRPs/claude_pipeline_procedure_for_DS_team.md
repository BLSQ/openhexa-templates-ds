# Procedure (v2): Developing DHIS2/OpenHEXA pipelines with Claude Code — **Docker & tests generated by Claude**

Audience: Data Scientists  
Goal: Ship OpenHEXA pipelines for DHIS2 fast, with a **default local DHIS2 (Sierra Leone) Docker harness** and **pytest**. The Docker/test setup is created by Claude from the PRPs and `prp_base.md` template.

---

## 0) One‑time setup

1) **VS Code + Claude Code**
   - Install VS Code and the Claude Code extension.
   - Sign in to Anthropic (your team key or your user key).

2) **Repo skeleton (recommended)**
   ```text
   repo/
     PRPs/
       <feature>.md                # your product requirement for the pipeline
     prp_base.md                   # the team base template (enforces Docker+tests by default)
   ```

3) **Open the right tabs in VS Code**
   - Open `prp_base.md` and your feature PRP (`PRPs/<feature>.md`) in editor tabs. Claude will use open tabs as context.
   - Open any existing `pipelines/<pipeline_name>/pipeline.py` if you’re iterating.

---

## 1) Author the Feature PRP (what you want built)

Write/confirm the feature PRP (`PRPs/<feature>.md`):
- **Goal**: one clear outcome (e.g. “Sync DataElement values S→T dataset by mapping”).  
- **Parameters**: name, type, required, defaults (use the OpenHEXA decorators from `prp_base.md`).  
- **Blueprint**: tasks in order (validate → extract → transform → post → summary).  
- **Schemas**: mapping JSON example, expected payloads.  
- **Validation/Gotchas**: period formats, DE/COC mapping, orgUnit presence, duplicates, dry run.  
- **Testing**: unit + a dry‑run integration test (Claude will scaffold the harness, you just specify the intent and assertions).

> Tip: Keep it concise and concrete. The stricter the PRP, the better the code generation.

---

## 2) Ask Claude to scaffold everything (code + Docker + tests)

With `prp_base.md` and the feature PRP open, start a Claude session and paste one of these prompts.

### Prompt A — New pipeline
```
Use the rules in prp_base.md and the requirements in PRPs/<feature>.md.
Create a new pipeline at pipelines/<pipeline_name>/:
- pipeline.py with @pipeline/@task/@parameter per prp_base.md
- README.md and requirements.txt
Also generate the default local test harness:
- docker-compose.dhis2.yml (core 40.x, Sierra Leone DB seed)
- docker/Dockerfile.tests (pytest + openhexa-toolbox + openhexa.sdk)
- Makefile with up/test/down targets
- tests/ with unit + integration (dry-run) based on the PRP's Testing section
Follow the Success checklist in prp_base.md. Show diffs only, no placeholders.
```

### Prompt B — Iterate/fix based on failing tests
```
Here is the failing test output (paste). Fix the implementation in pipelines/<pipeline_name>/pipeline.py.
Keep public parameters stable. Update tests only if the PRP explicitly requires it.
Re-run tests and provide a brief passing summary.
```

---

## 3) Run locally (standard workflow)

> Claude creates the files; you just run them.

1) **Start DHIS2 (first run pulls & seeds Sierra Leone DB)**
```bash
make up
```
This brings up DHIS2 at `http://localhost:8080` with credentials `admin` / `district` by default.

2) **Run tests inside the OpenHEXA‑like container**
```bash
make test
```
- Executes `pytest` using the generated `docker/Dockerfile.tests` image.
- Reads `.env.dhis2` if present (URL/creds/dataset IDs).

3) **Tear down**
```bash
make down
```

---

## 4) What “done” means (acceptance)

Before merging:
- ✅ OpenHEXA decorators + toolbox helpers only (no raw HTTP when helper exists).  
- ✅ Unit tests + **integration (dry‑run)** tests **pass** via `make test`.  
- ✅ DHIS2 Docker harness present (`docker-compose.dhis2.yml`, `Dockerfile.tests`, `Makefile`).  
- ✅ Lint + types pass: `ruff` and `mypy`.  
- ✅ README documents parameters, mapping schema, and run commands.  
- ✅ No TODOs/placeholders; logs are explicit and actionable.

---

## 5) Common tweaks you may ask Claude to do

- **Add a parameter**:  
  “Add `skip_zeros: bool = True` and propagate it through transform & posting. Update tests.”
- **Tighten validation**:  
  “Reject invalid `YYYYWnn` period formats with a helpful error; unit test it.”
- **Handle conflicts**:  
  “Parse DHIS2 import summary conflicts into the final report; add assertions.”
- **Performance**:  
  “Batch posting by 5k values; keep memory under 1GB; include a benchmark test.”

---

## 6) Troubleshooting

- **DHIS2 is slow on first boot**: the Sierra Leone DB import can take a while. `make logs` to watch progress.  
- **Port 8080 busy**: stop other services or change the published port in `docker-compose.dhis2.yml`.  
- **Tests can’t reach DHIS2**: ensure `make up` finished; verify `DHIS2_URL` in `.env.dhis2`.  
- **Network on Windows**: if `--network host` is not supported, rely on compose service names and container networking (Claude’s default harness already uses standard compose networking).

---

## 7) Minimal daily checklist

1. Update/confirm the feature PRP.  
2. Ask Claude to scaffold or adjust code/tests.  
3. `make up && make test`.  
4. Review diffs and logs, iterate with Claude using failing outputs.  
5. Merge only when the acceptance list is fully green.

