# DHIS2 Pipelines â€“ Base Rules (PRP / CLAUDE)

> **Default behavior:** Every pipeline MUST ship with **full test harness** (unit + integration) that runs inside a container based on the OpenHEXA stack. All examples and commands below are normative and should be generated by Claude for every new pipeline. It can if specified also be shipped with a local instance of Sierra Leone DHIS2 via Docker for testing purposes. But preferred way is connection to a server directly trough connections.

---

## 1) Scope
- Extract, transform, write, or sync DHIS2 data using OpenHEXA pipelines.
- Pipelines are structured with `@pipeline`, `@parameter` decorators only.
- Use `openhexa-toolbox.dhis2` helpers whenever possible (avoid raw HTTP if a helper exists).

---

## 2) Golden Rules
- **Parameters** come from OpenHEXA or CLI flags; **no hardcoded secrets/URLs**.
- **Use openhexa-toolbox methods** when available and working (Note: use `client.api.get("system/info")` for connection testing as `client.ping()` tries non-existent endpoint).
- **Deterministic & testable** code (pure functions where possible).
- **Logging** at task boundaries (inputs summary, counts, warnings, errors).

---

## 3) Pipeline Structure Pattern (MANDATORY)

Follow the **exact pattern** from `dhis2_extract_data_elements/pipeline.py`:

### 3.1 Parameter Definition
```python
@pipeline("dhis2-pipeline-name")
@parameter(
    code="source_connection",
    type=DHIS2Connection,
    name="Source DHIS2 instance",
    help="Source DHIS2 instance to extract data from",
    required=True,
)
@parameter(
    code="program",
    type=str,
    name="Program",
    help="Program UID from which to extract data",
    required=True,
)
@parameter(
    code="output_format",
    type=str,
    name="Output Format",
    help="Output format: csv, jsonl, parquet",
    default="parquet",
)
def dhis2_pipeline_name(
    source_connection: DHIS2Connection,
    program: str,
    output_format: str = "parquet",
) -> dict[str, Any]:
    """Main pipeline function."""
    current_run.log_info("Starting pipeline")
    
    # Call helper functions directly
    client = validate_connection(source_connection, program)
    data = extract_data(client, program)
    output_path = write_output(data, output_format)
    
    return {"output_path": output_path, "records": len(data)}


# Make pipeline executable directly
if __name__ == "__main__":
    dhis2_pipeline_name()
```

### 3.2 Helper Functions (Simple Pattern)
```python
def validate_connection(source_connection: DHIS2Connection, program: str) -> DHIS2:
    """Validate DHIS2 connection and program existence."""
    current_run.log_info("Validating connection")
    
    client = DHIS2(source_connection)
    
    # Test connection by getting system info (validates credentials)
    try:
        info = client.api.get("system/info")
        current_run.log_info(f"Connected to DHIS2 version: {info.get('version', 'unknown')}")
    except Exception as e:
        raise ValueError(f"Cannot connect to DHIS2: {e}") from e
    
    # Validate program exists
    try:
        program_info = client.api.get(f"programs/{program}", params={"fields": "id,name"})
        current_run.log_info(f"Found program: {program_info.get('name', program)}")
    except Exception as e:
        raise ValueError(f"Program '{program}' not found: {e}") from e
    
    return client
```

---

## 4) Required Imports (EXACT SYNTAX)
```python
from datetime import datetime
from pathlib import Path
from typing import Any

import polars as pl  # Use Polars for data processing
from openhexa.sdk import DHIS2Connection, current_run, parameter, pipeline, workspace
from openhexa.toolbox.dhis2 import DHIS2
```

---

## 5) Local Test Environment (MANDATORY)
Every repo MUST include the following files and default commands (if not optional: DHIS2 local instance).

### 5.1 `docker-compose.dhis2.yml`
```yaml
services:
  dhis2:
    image: ${DHIS2_IMAGE:-dhis2/core:40.8.0}
    environment:
      - WAIT_FOR_DB=true
      - JAVA_OPTS=-Xms1g -Xmx2g
      - DHIS2_DB_DUMP_URL=${DHIS2_DB_DUMP_URL:-https://databases.dhis2.org/sierra-leone/2.40/dhis2-db-sierra-leone.sql.gz}
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "-q", "-S", "http://localhost:8080", "-O", "/dev/null"]
      interval: 20s
      timeout: 5s
      retries: 30
```

### 5.2 `docker/Dockerfile.tests`
```dockerfile
FROM python:3.11-slim
WORKDIR /workspace

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl ca-certificates git && rm -rf /var/lib/apt/lists/*

RUN pip install --no-cache-dir \
    openhexa.sdk openhexa-toolbox pytest pytest-cov ruff mypy

COPY . /workspace

CMD ["pytest", "-q"]
```

### 5.3 `.env.example` (checked in)
```
# DHIS2 (local Sierra Leone)
DHIS2_URL=http://localhost:8080
DHIS2_USER=admin
DHIS2_PASS=district
# Optional: tweak versions
DHIS2_IMAGE=dhis2/core:40.8.0
DHIS2_DB_DUMP_URL=https://databases.dhis2.org/sierra-leone/2.40/dhis2-db-sierra-leone.sql.gz
```

### 5.4 `pytest.ini`
```ini
[pytest]
addopts = -q -ra
testpaths = tests
pythonpath = .
```

### 5.5 `workspace.yaml` (MANDATORY)
Note: Check https://play.im.dhis2.org/ for current stable DHIS2 demo server URLs.

```yaml
database:
  host: localhost
  username: some_username
  password: some_password
  dbname: the_db_name
  port: 5432
files:
  path: ./workspace
connections:
  dhis2-demo-2-41:
    type: dhis2
    url: https://play.im.dhis2.org/stable-2-41-3-1
    username: admin
    password: district
  dhis2-demo-2-39:
    type: dhis2
    url: https://play.im.dhis2.org/stable-2-39-10-1
    username: admin
    password: district
```

### 5.6 `parameters.json` (MANDATORY)
Example parameter values for testing the pipeline:
```json
{
    "source_connection": "dhis2-demo-2-39",
    "program": "IpHINAT79UW",
    "program_stage": null,
    "org_units": [
        "DiszpKrYNg8",
        "jUb8gELQApl"
    ],
    "status": "COMPLETED",
    "since_date": "2020-01-01",
    "output_format": "parquet",
    "output_path": null
}
```

---

## 6) Test Structure (EXACT PATTERN)

### 6.1 `tests/conftest.py`
```python
import os
import pytest
from openhexa.toolbox.dhis2 import DHIS2

@pytest.fixture(scope="session")
def dhis2_env():
    return {
        "url": os.getenv("DHIS2_URL", "https://play.im.dhis2.org/stable-2-39-10-1"),
        "user": os.getenv("DHIS2_USER", "admin"),
        "password": os.getenv("DHIS2_PASS", "district"),
    }

@pytest.fixture(scope="session")
def dhis2_client(dhis2_env):
    """Create DHIS2 client with fallback to demo servers."""
    # Check https://play.im.dhis2.org/ for current stable versions
    servers = [
        dhis2_env,
        {"url": "https://play.im.dhis2.org/stable-2-39-10-1", "user": "admin", "password": "district"},
        {"url": "https://play.im.dhis2.org/stable-2-41-3-1", "user": "admin", "password": "district"},
    ]
    
    for server_config in servers:
        try:
            client = DHIS2(
                url=server_config["url"],
                username=server_config["user"],
                password=server_config["password"],
            )
            client.api.get("system/info")
            return client
        except Exception:
            continue
    
    # Return last config for graceful test skipping
    return DHIS2(
        url=dhis2_env["url"],
        username=dhis2_env["user"],
        password=dhis2_env["password"],
    )
```

### 6.2 Test Pattern (for helper functions)
```python
import pipeline as pipeline_module
from unittest.mock import MagicMock
import pytest
from openhexa.sdk import DHIS2Connection

def test_helper_function_unit():
    """Test helper function directly."""
    result = pipeline_module.build_query_params(
        program="TEST_PROGRAM",
        status="COMPLETED",
        since_date="2024-01-01",
    )
    
    assert result["program"] == "TEST_PROGRAM"
    assert result["status"] == "COMPLETED"

@pytest.mark.integration
def test_helper_function_integration(dhis2_client, dhis2_env):
    """Test helper function with real DHIS2."""
    mock_connection = MagicMock(spec=DHIS2Connection)
    mock_connection.url = dhis2_env["url"]
    mock_connection.username = dhis2_env["user"] 
    mock_connection.password = dhis2_env["password"]
    
    try:
        dhis2_client.api.get("system/info")
    except Exception as e:
        pytest.skip(f"DHIS2 not accessible: {e}")
    
    result = pipeline_module.validate_connection(mock_connection, "IpHINAT79UW")
    assert result is not None
```

---

## 7) Commands (developer quickstart)
```bash
# 1) Start DHIS2 locally
docker compose -f docker-compose.dhis2.yml up -d

# 2) Build test runner image
docker build -t ohx-tests -f docker/Dockerfile.tests .

# 3) Run tests inside container
docker run --rm --network host --env-file .env.example -v "$PWD":/workspace ohx-tests

# Optional: Makefile
make up      # Start DHIS2
make test    # Run tests
make down    # Stop DHIS2
```

---

## 8) Success Checklist
- [ ] Uses OpenHEXA decorators and follows reference pattern exactly.
- [ ] Simple helper functions (no complex dual-function architecture).
- [ ] Includes `if __name__ == "__main__":` block to make pipeline executable.
- [ ] All tests green locally (Docker) and in CI.
- [ ] `ruff` + `mypy` pass.
- [ ] README documents parameters and run commands.

---

## 9) Anti-patterns
- Complex dual-function architecture with @task decorators
- Raw `requests` when toolbox has an equivalent.
- Hardcoding dataset/orgUnit/period/URL/credentials.
- Skipping validation/logging.
- Delivering code without tests or Docker harness.

---

## 10) Real Examples

Use these existing pipelines as reference for exact syntax and patterns:
- `dhis2_extract_data_elements/pipeline.py` (main reference)
- `dhis2_metadata_extract/pipeline.py` (alternative patterns)

**CRITICAL:** Always follow the reference pipeline pattern exactly, not the complex patterns in older versions of this document.